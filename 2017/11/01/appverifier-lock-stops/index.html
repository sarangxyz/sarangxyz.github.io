<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>appverifier lock stops - a few notes..</title><meta name=description content="details on various appverifier lock stops"><meta name=author content="Sarang Baheti"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"a few notes..","url":"https:\/\/www.variadic.xyz\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/www.variadic.xyz\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/www.variadic.xyz\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/www.variadic.xyz\/2017\/11\/01\/appverifier-lock-stops\/","name":"Appverifier lock stops"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Sarang Baheti"},"headline":"appverifier lock stops","description":"details on various appverifier lock stops","inLanguage":"en","wordCount":1493,"datePublished":"2017-11-01T10:54:24","dateModified":"2017-11-01T10:54:24","image":"https:\/\/www.variadic.xyz\/","keywords":["windows, debug, windbg"],"mainEntityOfPage":"https:\/\/www.variadic.xyz\/2017\/11\/01\/appverifier-lock-stops\/","publisher":{"@type":"Organization","name":"https:\/\/www.variadic.xyz\/","logo":{"@type":"ImageObject","url":"https:\/\/www.variadic.xyz\/","height":60,"width":60}}}</script><meta property="og:title" content="appverifier lock stops"><meta property="og:description" content="details on various appverifier lock stops"><meta property="og:url" content="https://www.variadic.xyz/2017/11/01/appverifier-lock-stops/"><meta property="og:type" content="website"><meta property="og:site_name" content="a few notes.."><meta name=twitter:title content="appverifier lock stops"><meta name=twitter:description content="details on various appverifier lock stops"><meta name=twitter:card content="summary_large_image"><meta name=generator content="Hugo 0.101.0"><link rel=alternate href=https://www.variadic.xyz/index.xml type=application/rss+xml title="a few notes.."><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://www.variadic.xyz/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://www.variadic.xyz/css/syntax.css><link rel=stylesheet href=https://www.variadic.xyz/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-27935503-1","auto"),ga("send","pageview"))</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://www.variadic.xyz/>a few notes..</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Notes href=/>Notes</a></li><li><a title=Archive href=/archive/>Archive</a></li><li><a title=Tags href=/tags/>Tags</a></li><li><a title=About href=/about/>About</a></li><li><a title=Disclaimer href=/disclaimer/>Disclaimer</a></li><li><a title=Books href=/books/>Books</a></li></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>appverifier lock stops</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on November 1, 2017</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>Reference: <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd371695(v=vs.85).aspx">AppVerifier Locks</a>
This is more of a dump from various pages of MSDN for handy reference.</p><link rel=stylesheet href=https://www.variadic.xyz/css/hugo-easy-gallery.css><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/images/appverifier-locks.png alt=/images/appverifier-locks.png></div><a href=/images/appverifier-locks.png itemprop=contentUrl></a></figure></div><p>A few links i have found useful over time are:</p><ul><li><a href=https://blogs.msdn.microsoft.com/meason/2010/03/25/application-verifier-for-locks-usage/>application-verifier-for-locks-usage</a></li><li><a href=https://blogs.technet.microsoft.com/yongrhee/2013/10/17/how-to-debug-critical-section-issues-using-appverifier/>how-to-debug-critical-section-issues-using-appverifier</a></li></ul><hr><h3 id=200><code>200:</code></h3><p>This stop is generated if a thread (thread ID is parameter1) is terminated, suspended or is in a state worker thread finished a work item) in which it cannot hold a critical section. The current thread is the culprit. To debug this stop use the following debugger commands:</p><ul><li><code>$ kb</code> - to get the current stack trace. If the current thread is the owner of the critical section it is probably calling <code>ExitThread</code>. The current thread should have released the critical section before exiting. If the current thread is calling <code>TerminateThread</code> or <code>SuspendThread</code> then it should not do this for a thread holding a critical section.</li><li><code>$ !cs -s parameter2</code> - dump information about this critical section.</li><li><code>$ ln parameter2</code> - to show symbols near the address of the critical section. This should help identify the leaked critical section.</li><li><code>$ dps parameter4</code> - to dump the stack trace for this critical section initialization.</li></ul><hr><h3 id=201><code>201:</code></h3><p>This stop is generated if a DLL has a global variable containing a critical section and the DLL is unloaded but the critical section has not been deleted. To debug this stop use the following debugger commands:</p><ul><li><code>$ du parameter3</code> - to dump the name of the culprit DLL.</li><li><code>$ .reload dllname</code> or <code>.reload dllname = parameter4</code> - to reload the symbols for that DLL.</li><li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li><li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the leaked critical section.</li><li><code>$ dps parameter2</code> - to dump the stack trace for this critical section initialization.</li></ul><hr><h3 id=202><code>202:</code></h3><p>This stop is generated if a heap allocation contains a critical section, the allocation is freed and the critical section has not been deleted. To debug this stop use the following debugger commands:</p><ul><li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li><li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the leaked critical section.</li><li><code>$ dps parameter2</code> - to dump the stack trace for this critical section initialization.</li><li><code>$ parameter3</code> and parameter4 might help understand where this heap block was allocated (the size of the allocation is probably significant).</li></ul><hr><h3 id=203><code>203:</code></h3><p>Usually this stop is generated if a critical section has been initialized more than one time. In this case <code>parameter3</code> and <code>parameter4</code> are the stack trace addresses for two of these initializations. Some other times it is possible to get this stop if the critical section or its debug information structure has been corrupted. In this second case it is possible that parameter3 and parameter4 are invalid and useless. To debug this stop:</p><ul><li><code>$ !cs -s -d parameter2</code> - dump information about this critical section.</li><li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This might help identify the critical section if this is a global variable.</li><li><code>$ dps parameter3</code> and <code>dps parameter4</code> - to identify the two code paths for initializing this critical section.</li></ul><hr><h3 id=204><code>204:</code></h3><p>This stop is generated if the memory containing a critical section was freed but the critical section has not been deleted using <code>DeleteCriticalSection</code>. To debug this stop use the following debugger commands:</p><ul><li><code>$ !cs -s -d parameter2</code> - dump information about this critical section.</li><li><code>$ dps parameter3</code> - to identify the code path for initializing this critical section.</li></ul><p>In most cases the lock verifier detects immediately leaked critical sections contained in a heap allocation, a DLL range, a virtual memory allocation or a <code>MapViewOfFile</code> mapped memory range and issues different stops in these cases. So there are very few cases left for this verifier stop. The lock must be in a memory range freed by kernel-mode code or freed cross-process by APIs like <code>VirtualFreeEx</code>. Most typically this stop will be encountered if a previous stop (e.g. <code>LOCK_IN_FREED_HEAP</code> or <code>LOCK_IN_UNLOADED_DLL</code>) was continued by hitting <code>g</code> in the debugger console.</p><hr><h3 id=205><code>205:</code></h3><p>This stop is generated if the DebugInfo field of the critical section is pointing freed memory. Usually another valid DebugInfo structure is found in the active critical section list. Without corruption the two pointers should be identical. To debug this stop use the following debugger commands:</p><ul><li><code>$ !cs -s -d parameter3</code> - dump information about this critical section based on the current contents of the debug info structure found in the active list (this structure is rarely corrupted so usually this information is trustworthy).</li><li><code>$ !cs -s parameter1</code> - dump information about this critical section based on the current contents of the critical section structure (the structure is corrupted already so sometimes this information is NOT trustworthy).</li><li><code>$ dps parameter4</code> - to identify the code path for initializing this critical section.</li></ul><p>Dump the critical section at address parameter1 and look for the corruption pattern. With good symbols for ntdll.dl you can use the following commands:</p><ul><li><code>$ dt ntdll!_RTL_CRITICAL_SECTION LOCK_ADDRESS</code></li><li><code>$ dt ntdll!_RTL_CRITICAL_SECTION_DEBUG DEBUG_ADDRESS</code></li></ul><hr><h3 id=206><code>206:</code></h3><p>This stop is generated if the owner thread ID is invalid in the current context. For example, the critical section is being released by a thread other than the one that acquired it. To debug this stop:</p><ul><li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li><li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li></ul><hr><h3 id=207><code>207:</code></h3><p>This stop is generated if the recursion count field of the critical section structure is invalid in the current context. To debug this stop:</p><ul><li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li><li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li></ul><hr><h3 id=208><code>208:</code></h3><p>This stop is generated if a critical section is owned by a thread if it is deleted or if the critical section is uninitialized. To debug this stop:</p><ul><li><code>$ !cs -s parameter1</code> - dump information about this critical section. If the owning thread is 0 the critical section has not been initialized.</li><li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li></ul><hr><h3 id=209><code>209:</code></h3><p>This stop is generated if a critical section is released more times than the current thread acquired it. To debug this stop:</p><ul><li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li><li><code>$ !cs -s -d parameter4</code> - dump information about this critical section.</li><li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li></ul><hr><h3 id=210><code>210:</code></h3><p>This stop is generated if a critical section is used without being initialized or after it has been deleted. To debug this stop:</p><ul><li><code>$ ln parameter1</code> - to show symbols near the address of the critical section. This should help identify the critical section.</li></ul><hr><h3 id=211><code>211:</code></h3><p>This stop is generated if a critical section is reinitialized by the current thread. To debug this stop:</p><ul><li><code>$ !cs -s parameter1</code> or <code>!cs -s -d parameter2</code> - dump information about this critical section.</li><li><code>$ ln parameter1</code> - to show symbols near the address of the critical section.</li></ul><p>This might help identify the critical section if this is a global variable.</p><hr><h3 id=212><code>212:</code></h3><p>This stop is generated if the current thread is calling <code>VirtualFree</code> on a memory block that contains an active critical section. The application should call <code>DeleteCriticalSection</code> on this critical section before if frees this memory.</p><ul><li><code>$ kb</code> - to display the current stack trace, that is calling VirtualFree. The probable culprit is the DLL that calls VirtualFree.</li><li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li><li><code>$ dps parameter2</code> - to identify the code path for the initialization of this critical section.</li></ul><hr><h3 id=213><code>213:</code></h3><p>This stop is generated if the current thread is calling <code>UnmapViewOfFile</code> on a memory block that contains an active critical section. The application should call <code>DeleteCriticalSection</code> on this critical section before if unmaps this memory.</p><ul><li><code>$ kb</code> - to display the current stack trace, that is calling <code>UnmapViewOfFile</code> . The probable culprit is the DLL that calls <code>UnmapViewOfFile</code>.</li><li><code>$ !cs -s parameter1</code> - dump information about this critical section.</li><li><code>$ dps parameter2</code> - to identify the code path for the initialization of this critical section.</li></ul><hr><h3 id=214><code>214:</code></h3><p>This stop is generated if the current thread is calling <code>LeaveCriticalSection</code> but, according to the internal verifier bookkeeping, it doesn&rsquo;t own any critical section.</p><p>If <code>parameter2</code> is zero, probably this is a bug in the current thread.
It either tries to leave a critical section that it didn&rsquo;t enter, or maybe it is calling <code>LeaveCriticalSection</code> more times than it called <code>EnterCriticalSection</code> for the same critical section.</p><hr><h3 id=215><code>215:</code></h3><p>This stop is generated if the current thread tries to use a private lock that livesinside another DLL. For example a.dll tries to enter a critical section defined inside ntdll.dll. Private locks cannot be used across DLLs.</p><div class=blog-tags><a href=https://www.variadic.xyz//tags/windows/>windows</a>&nbsp;
<a href=https://www.variadic.xyz//tags/debug/>debug</a>&nbsp;
<a href=https://www.variadic.xyz//tags/windbg/>windbg</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://www.variadic.xyz/2017/10/31/library-loading-issues-windows/ data-toggle=tooltip data-placement=top title="debugging library load issues on windows">&larr; Previous Post</a></li><li class=next><a href=https://www.variadic.xyz/post/0119-error-handling-links/ data-toggle=tooltip data-placement=top title="Error Handling Links">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">Sarang Baheti
&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://www.variadic.xyz/>a few notes..</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.101.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity=sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://www.variadic.xyz/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://www.variadic.xyz/js/load-photoswipe.js></script></body></html>