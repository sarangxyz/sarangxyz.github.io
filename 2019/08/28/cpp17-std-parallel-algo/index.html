<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>cpp17 std parallel algo - a few notes</title><meta name=description content="notes on cpp17 std parallel algo"><meta name=author content="Sarang Baheti"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"a few notes","url":"https:\/\/www.variadic.xyz\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/www.variadic.xyz\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/www.variadic.xyz\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/www.variadic.xyz\/2019\/08\/28\/cpp17-std-parallel-algo\/","name":"Cpp17 std parallel algo"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Sarang Baheti"},"headline":"cpp17 std parallel algo","description":"notes on cpp17 std parallel algo","inLanguage":"en","wordCount":748,"datePublished":"2019-08-28T00:00:00","dateModified":"2019-08-28T00:00:00","image":"https:\/\/www.variadic.xyz\/","keywords":["C\u002b\u002b, C\u002b\u002b17"],"mainEntityOfPage":"https:\/\/www.variadic.xyz\/2019\/08\/28\/cpp17-std-parallel-algo\/","publisher":{"@type":"Organization","name":"https:\/\/www.variadic.xyz\/","logo":{"@type":"ImageObject","url":"https:\/\/www.variadic.xyz\/","height":60,"width":60}}}</script><meta property="og:title" content="cpp17 std parallel algo"><meta property="og:description" content="notes on cpp17 std parallel algo"><meta property="og:url" content="https://www.variadic.xyz/2019/08/28/cpp17-std-parallel-algo/"><meta property="og:type" content="website"><meta property="og:site_name" content="a few notes"><meta name=twitter:title content="cpp17 std parallel algo"><meta name=twitter:description content="notes on cpp17 std parallel algo"><meta name=twitter:card content="summary_large_image"><meta name=generator content="Hugo 0.101.0"><link rel=alternate href=https://www.variadic.xyz/index.xml type=application/rss+xml title="a few notes"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://www.variadic.xyz/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://www.variadic.xyz/css/syntax.css><link rel=stylesheet href=https://www.variadic.xyz/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-27935503-1","auto"),ga("send","pageview"))</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://www.variadic.xyz/>a few notes</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Notes href=/>Notes</a></li><li><a title=Archive href=/archive/>Archive</a></li><li><a title=Tags href=/tags/>Tags</a></li><li><a title=About href=/about/>About</a></li><li><a title=Disclaimer href=/disclaimer/>Disclaimer</a></li></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>cpp17 std parallel algo</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 28, 2019</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h2 id=parallel-algorithms>parallel algorithms</h2><p>The C++17 standard added the concept of parallel algorithms to the C++ Standard Library. These are additional overloads of many of the functions that operate on ranges. The parallel versions have the same signature as the �normal� single-threaded versions, except for the addition of a new first parameter, which specifies the execution policy to use.</p><p>The execution policies as defined in C++17 are:</p><ul><li>std::execution::seq</li><li>std::execution::par</li><li>std::execution::par_unseq</li></ul><p><br>links:</p><ol start=0><li><a href=https://en.cppreference.com/w/cpp/algorithm>cppreference alogrithm</a></li><li><a href=https://en.cppreference.com/w/cpp/algorithm/execution_policy_tag_t>cppreference</a></li><li><a href=http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2016/p0024r2.html#algorithms.parallel.exec>P0024R2</a></li><li><a href=https://software.intel.com/en-us/articles/get-started-with-parallel-stl>intel gettint started with pstl</a></li><li><a href=https://github.com/n3554/n3554>n3554 github, NVidia</a></li><li><a href=https://github.com/KhronosGroup/SyclParallelSTL>opencl based SyclParallelSTL</a></li><li>[parallel algorithm performance] (<a href=https://www.bfilipek.com/2018/11/parallel-alg-perf.html>https://www.bfilipek.com/2018/11/parallel-alg-perf.html</a>)</li><li><a href=https://devblogs.microsoft.com/cppblog/using-c17-parallel-algorithms-for-better-performance/>msdn cpp17 paralgo</a></li><li><a href=https://en.cppreference.com/w/cpp/experimental/parallelism/existing>cpp17 parallelized algo</a></li></ol><p> </p><h2 id=policy>policy</h2><pre tabindex=0><code>Lattice representation of policies, as in C++17

                par_unseq
                /       \
               /         \
              /           \
             seq          par
</code></pre><h3 id=seq-policy>seq policy</h3><p>This is a serial execution, not a policy for parallelism. This has same algorithmic complexity as standard/normal implementation. It is executed in calling thread and in the order specified (definite order rather interleaved).</p><h3 id=par-policy>par policy</h3><p>This policy provides for parallel execution across threads, #threads is defined by implementation. This may execute in main thread or in background threads. Any such invocations executing in the same thread are indeterminately sequenced with respect to each other.</p><h3 id=par_unseq-policy>par_unseq policy</h3><p>This policy provides for max scope for parallelizing algorithm. The invocations are permitted to execute in an unordered fashion in unspecified threads, and unsequenced with respect to one another within each thread
The execution order is not defined as execution could be interleaved. Basically it allows for parallel+vectorization</p><ol><li><a href=https://stackoverflow.com/questions/43488032/whats-the-point-of-stdexecutionpar-unseq>whats-the-point-of-stdexecutionpar-unseq</a></li><li><a href=https://stackoverflow.com/a/47706880/916549>difference-between-execution-policies</a></li></ol><p> </p><h2 id=exception-behavior>exception behavior</h2><p>During the execution of a parallel algorithm with any of these execution policies, if the invocation of an element access function exits via an uncaught exception, std::terminate is called, but the implementations may define additional execution policies that handle exceptions differently.</p><p>Basically, this is where the behavior diverges with respect to pre-C++17 algorithms.</p><ol><li><a href=http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2016/p0024r2.html#algorithms.parallel.exceptions>Parallel algorithm exceptions</a></li></ol><p><br>An an example this simple loop could be parallelized to do some operation:</p><div class=highlight><div style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>    <span style=color:#00a8c8>for</span><span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>idx</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>idx</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>HEIGHT</span><span style=color:#111>;</span> <span style=color:#f92672>++</span><span style=color:#111>idx</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>}</span>
</span></span></code></pre></td></tr></table></div></div><p>becomes:</p><div class=highlight><div style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>	<span style=color:#111>std</span><span style=color:#f92672>::</span><span style=color:#111>vector</span><span style=color:#f92672>&lt;</span><span style=color:#00a8c8>int</span><span style=color:#f92672>&gt;</span> <span style=color:#111>ivec</span><span style=color:#111>{};</span>
</span></span><span style=display:flex><span>	<span style=color:#111>ivec</span><span style=color:#111>.</span><span style=color:#111>resize</span><span style=color:#111>(</span><span style=color:#111>HEIGHT</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span><span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>idx</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>idx</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>ivec</span><span style=color:#111>.</span><span style=color:#111>size</span><span style=color:#111>();</span> <span style=color:#f92672>++</span><span style=color:#111>idx</span><span style=color:#111>)</span> <span style=color:#111>ivec</span><span style=color:#111>[</span><span style=color:#111>idx</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>idx</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#111>std</span><span style=color:#f92672>::</span><span style=color:#111>for_each</span><span style=color:#111>(</span><span style=color:#111>std</span><span style=color:#f92672>::</span><span style=color:#111>execution</span><span style=color:#f92672>::</span><span style=color:#111>par_unseq</span><span style=color:#111>,</span> <span style=color:#111>ivec</span><span style=color:#111>.</span><span style=color:#111>begin</span><span style=color:#111>(),</span> <span style=color:#111>ivec</span><span style=color:#111>.</span><span style=color:#111>end</span><span style=color:#111>(),</span> 
</span></span><span style=display:flex><span>                <span style=color:#111>[</span><span style=color:#f92672>&amp;</span><span style=color:#111>](</span><span style=color:#00a8c8>int</span> <span style=color:#111>i</span><span style=color:#111>)</span><span style=color:#f92672>-&gt;</span><span style=color:#00a8c8>void</span>
</span></span><span style=display:flex><span>                <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#111>});</span>
</span></span></code></pre></td></tr></table></div></div><p>this is lot more verbose than where we started, but it allows for parallelization without much fuss. Also it is easy to run this serially by changing <code>std::execution::par_unseq</code> to <code>std::execution::seq</code>, keeping the exceptoin behavior the same (as noted above). I kind of like <code>Intel TBB</code> better in this case:</p><div class=highlight><div style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#111>constexprt</span> <span style=color:#111>size_t</span> <span style=color:#111>Stride</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span> <span style=color:#75715e>// parallel, setting this to HEIGHT+1 will make it serialized
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#111>tbb</span><span style=color:#f92672>::</span><span style=color:#111>parallel_for</span><span style=color:#111>(</span><span style=color:#111>tbb</span><span style=color:#f92672>::</span><span style=color:#111>blocked_range</span><span style=color:#f92672>&lt;</span><span style=color:#111>size_t</span><span style=color:#f92672>&gt;</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>HEIGHT</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>                <span style=color:#111>[</span><span style=color:#f92672>&amp;</span><span style=color:#111>](</span><span style=color:#00a8c8>const</span> <span style=color:#111>tbb</span><span style=color:#f92672>::</span><span style=color:#111>blocked_range</span><span style=color:#f92672>&lt;</span><span style=color:#111>size_t</span><span style=color:#f92672>&gt;&amp;</span> <span style=color:#111>range</span><span style=color:#111>)</span><span style=color:#f92672>-&gt;</span><span style=color:#00a8c8>void</span>
</span></span><span style=display:flex><span>                <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>for</span><span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>idx</span> <span style=color:#f92672>=</span> <span style=color:#111>range</span><span style=color:#111>.</span><span style=color:#111>begin</span><span style=color:#111>();</span> <span style=color:#111>idx</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>range</span><span style=color:#111>.</span><span style=color:#111>end</span><span style=color:#111>();</span> <span style=color:#f92672>++</span><span style=color:#111>idx</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>                <span style=color:#111>});</span>
</span></span></code></pre></td></tr></table></div></div><p> </p><p>From implementation perspective, I think almost all will provide a thread-pool based execution implementation. At least thats what MS has done.
Line#11 is where the work is submitted to a common thread-pool. At Line#23 <code>_Run_chunked_parallel_work</code> does the work of populating work in ThreadPool thru <code>_Work_ptr</code>. From <code>for_each</code> perspective Line#40-Line#50 contains all the logic to convert a <code>for_each</code> iteration to #tasks for parallelization.</p><div class=highlight><div style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// https://github.com/microsoft/STL/blob/580e61a5f5536016f521cc1b2ca636eadc69bd30/stl/inc/execution
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// CLASS _Work_ptr
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>class</span> <span style=color:#75af00>_Work_ptr</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>void</span> <span style=color:#111>_Submit</span><span style=color:#111>(</span><span style=color:#00a8c8>const</span> <span style=color:#111>size_t</span> <span style=color:#111>_Submissions</span><span style=color:#111>)</span> <span style=color:#00a8c8>const</span> <span style=color:#00a8c8>noexcept</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>__std_bulk_submit_threadpool_work</span><span style=color:#111>(</span><span style=color:#111>_Ptp_work</span><span style=color:#111>,</span> <span style=color:#111>_Submissions</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>void</span> <span style=color:#75af00>_Submit_for_chunks</span><span style=color:#111>(</span><span style=color:#00a8c8>const</span> <span style=color:#111>size_t</span> <span style=color:#111>_Hw_threads</span><span style=color:#111>,</span> <span style=color:#00a8c8>const</span> <span style=color:#111>size_t</span> <span style=color:#111>_Chunks</span><span style=color:#111>)</span> <span style=color:#00a8c8>const</span> <span style=color:#00a8c8>noexcept</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>_Submit</span><span style=color:#111>(</span><span style=color:#111>_Min_value</span><span style=color:#111>(</span><span style=color:#111>_Hw_threads</span> <span style=color:#f92672>*</span> <span style=color:#111>_Oversubmission_multiplier</span><span style=color:#111>,</span> <span style=color:#111>_Chunks</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// FUNCTION TEMPLATE _Run_chunked_parallel_work
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>template</span> <span style=color:#f92672>&lt;</span><span style=color:#00a8c8>class</span> <span style=color:#75af00>_Work</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#111>_Run_chunked_parallel_work</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>const</span> <span style=color:#111>size_t</span> <span style=color:#111>_Hw_threads</span><span style=color:#111>,</span> <span style=color:#111>_Work</span><span style=color:#f92672>&amp;</span> <span style=color:#111>_Operation</span><span style=color:#111>)</span> <span style=color:#111>{</span> <span style=color:#75715e>// process chunks of _Operation on the thread pool
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>const</span> <span style=color:#111>_Work_ptr</span> <span style=color:#111>_Work_op</span><span style=color:#111>{</span><span style=color:#111>_Operation</span><span style=color:#111>};</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// setup complete, hereafter nothrow or terminate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>_Work_op</span><span style=color:#111>.</span><span style=color:#111>_Submit_for_chunks</span><span style=color:#111>(</span><span style=color:#111>_Hw_threads</span><span style=color:#111>,</span> <span style=color:#111>_Operation</span><span style=color:#111>.</span><span style=color:#111>_Team</span><span style=color:#111>.</span><span style=color:#111>_Chunks</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>_Run_available_chunked_work</span><span style=color:#111>(</span><span style=color:#111>_Operation</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>template</span> <span style=color:#f92672>&lt;</span><span style=color:#00a8c8>class</span> <span style=color:#75af00>_ExPo</span><span style=color:#111>,</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>_FwdIt</span><span style=color:#111>,</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>_Fn</span><span style=color:#111>,</span> <span style=color:#111>_Enable_if_execution_policy_t</span><span style=color:#f92672>&lt;</span><span style=color:#111>_ExPo</span><span style=color:#f92672>&gt;</span> <span style=color:#75715e>/* = 0 */</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#111>for_each</span><span style=color:#111>(</span><span style=color:#111>_ExPo</span><span style=color:#f92672>&amp;&amp;</span><span style=color:#111>,</span> <span style=color:#111>_FwdIt</span> <span style=color:#111>_First</span><span style=color:#111>,</span> <span style=color:#111>_FwdIt</span> <span style=color:#111>_Last</span><span style=color:#111>,</span> <span style=color:#111>_Fn</span> <span style=color:#111>_Func</span><span style=color:#111>)</span> <span style=color:#00a8c8>noexcept</span> <span style=color:#75715e>/* terminates */</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>...</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>const</span> <span style=color:#111>size_t</span> <span style=color:#111>_Hw_threads</span> <span style=color:#f92672>=</span> <span style=color:#111>__std_parallel_algorithms_hw_threads</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>_Hw_threads</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>{</span> <span style=color:#75715e>// parallelize on multiprocessor machines...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>auto</span> <span style=color:#111>_Count</span> <span style=color:#f92672>=</span> <span style=color:#111>_STD</span> <span style=color:#111>distance</span><span style=color:#111>(</span><span style=color:#111>_UFirst</span><span style=color:#111>,</span> <span style=color:#111>_ULast</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>_Count</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span> <span style=color:#111>{</span> <span style=color:#75715e>// ... with at least 2 elements
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#111>_TRY_BEGIN</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>auto</span> <span style=color:#111>_Passed_fn</span> <span style=color:#f92672>=</span> <span style=color:#111>_Pass_fn</span><span style=color:#111>(</span><span style=color:#111>_Func</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>_Static_partitioned_for_each2</span><span style=color:#f92672>&lt;</span><span style=color:#00a8c8>decltype</span><span style=color:#111>(</span><span style=color:#111>_UFirst</span><span style=color:#111>),</span> <span style=color:#00a8c8>decltype</span><span style=color:#111>(</span><span style=color:#111>_Count</span><span style=color:#111>),</span> <span style=color:#00a8c8>decltype</span><span style=color:#111>(</span><span style=color:#111>_Passed_fn</span><span style=color:#111>)</span><span style=color:#f92672>&gt;</span> <span style=color:#111>_Operation</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>_Hw_threads</span><span style=color:#111>,</span> <span style=color:#111>_Count</span><span style=color:#111>,</span> <span style=color:#111>_Passed_fn</span><span style=color:#111>};</span>
</span></span><span style=display:flex><span>                <span style=color:#111>_Operation</span><span style=color:#111>.</span><span style=color:#111>_Basis</span><span style=color:#111>.</span><span style=color:#111>_Populate</span><span style=color:#111>(</span><span style=color:#111>_Operation</span><span style=color:#111>.</span><span style=color:#111>_Team</span><span style=color:#111>,</span> <span style=color:#111>_UFirst</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>_Run_chunked_parallel_work</span><span style=color:#111>(</span><span style=color:#111>_Hw_threads</span><span style=color:#111>,</span> <span style=color:#111>_Operation</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>return</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                <span style=color:#111>_CATCH</span><span style=color:#111>(</span><span style=color:#00a8c8>const</span> <span style=color:#111>_Parallelism_resources_exhausted</span><span style=color:#f92672>&amp;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// fall through to serial case below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#111>_CATCH_END</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>     <span style=color:#111>...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></td></tr></table></div></div><p>I am quite curious when would MS throw <code>_Parallelism_resources_exhausted</code>. Perhaps needs more digging, for later..</p>&nbsp;<div class=blog-tags><a href=https://www.variadic.xyz//tags/c++/>C++</a>&nbsp;
<a href=https://www.variadic.xyz//tags/c++17/>C++17</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://www.variadic.xyz/2019/07/03/constexpr2/ data-toggle=tooltip data-placement=top title="constexpr vs C++ Template Metaprogramming">&larr; Previous Post</a></li><li class=next><a href=https://www.variadic.xyz/2019/09/15/shared-mutable-synchronization/ data-toggle=tooltip data-placement=top title="shared mutable synchronization">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">Sarang Baheti
&nbsp;&bull;&nbsp;&copy;
2023
&nbsp;&bull;&nbsp;
<a href=https://www.variadic.xyz/>a few notes</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.101.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity=sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://www.variadic.xyz/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://www.variadic.xyz/js/load-photoswipe.js></script></body></html>