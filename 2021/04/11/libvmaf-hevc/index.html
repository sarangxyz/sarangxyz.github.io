<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>using vmaf for encoder quality - a few notes</title><meta name=description content="checking encoder quality with ffmpeg and libvmaf (both windows and linux)"><meta name=author content="Sarang Baheti"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"a few notes","url":"https:\/\/www.variadic.xyz\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/www.variadic.xyz\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/www.variadic.xyz\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/www.variadic.xyz\/2021\/04\/11\/libvmaf-hevc\/","name":"Using vmaf for encoder quality"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Sarang Baheti"},"headline":"using vmaf for encoder quality","description":"checking encoder quality with ffmpeg and libvmaf (both windows and linux)","inLanguage":"en","wordCount":1298,"datePublished":"2021-04-11T00:00:00","dateModified":"2021-04-11T00:00:00","image":"https:\/\/www.variadic.xyz\/","keywords":["misc, linux"],"mainEntityOfPage":"https:\/\/www.variadic.xyz\/2021\/04\/11\/libvmaf-hevc\/","publisher":{"@type":"Organization","name":"https:\/\/www.variadic.xyz\/","logo":{"@type":"ImageObject","url":"https:\/\/www.variadic.xyz\/","height":60,"width":60}}}</script><meta property="og:title" content="using vmaf for encoder quality"><meta property="og:description" content="checking encoder quality with ffmpeg and libvmaf (both windows and linux)"><meta property="og:url" content="https://www.variadic.xyz/2021/04/11/libvmaf-hevc/"><meta property="og:type" content="website"><meta property="og:site_name" content="a few notes"><meta name=twitter:title content="using vmaf for encoder quality"><meta name=twitter:description content="checking encoder quality with ffmpeg and libvmaf (both windows and linux)"><meta name=twitter:card content="summary_large_image"><meta name=generator content="Hugo 0.101.0"><link rel=alternate href=https://www.variadic.xyz/index.xml type=application/rss+xml title="a few notes"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://www.variadic.xyz/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://www.variadic.xyz/css/syntax.css><link rel=stylesheet href=https://www.variadic.xyz/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-27935503-1","auto"),ga("send","pageview"))</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://www.variadic.xyz/>a few notes</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Notes href=/>Notes</a></li><li><a title=Archive href=/archive/>Archive</a></li><li><a title=Tags href=/tags/>Tags</a></li><li><a title=About href=/about/>About</a></li><li><a title=Disclaimer href=/disclaimer/>Disclaimer</a></li></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>using vmaf for encoder quality</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 11, 2021</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>I have been trying to convert/encode phone videos for archival and reduce filesizes. One of the ways to do is to re-encode with lower bitrate. That reduces size, but reduces quality as well. These days, most of the videos are either encoded in <a href=https://en.wikipedia.org/wiki/Advanced_Video_Coding>H264/AVC</a> or <a href=https://en.wikipedia.org/wiki/High_Efficiency_Video_Coding>H265/HEVC</a>.<br><br>Reading online, I found that HEVC/H265 is engineered to provide better quality in same bitrate or same-quality in ~50% bitrate of H264/AVC, thus the attraction.</p><p>Now, there are many tools to go about encoding/re-encoding:</p><ul><li><a href=https://handbrake.fr/>Handbrake</a></li><li><a href=https://github.com/staxrip/staxrip>Staxrip</a></li><li><a href=https://www.ffmpeg.org/>ffmpeg</a></li><li><a href=https://www.videolan.org/>vlc</a></li><li><a href=https://www.apple.com/final-cut-pro/>Final Cut Pro</a></li><li><a href=https://www.adobe.com/products/premiere.html>Adobe Premiere Pro</a></li><li>&mldr;</li></ul><p><br>Handbrake, Starxrip, ffmepg and vlc all build on libavcodec and use same tools underneath. All three except ffmpeg have a ui. Exposing controls and parameters to some extent. I have tried all, and have mostly settled on ffmpeg and staxrip now.</p><hr><p>As far as encoding is concerned there are plethora of tools, but validating still requires very specific tools. Again ffmpeg is the best case here.</p><p>From validation perspective, there are multiple metrics to validate quality on:</p><ul><li><a href=https://en.wikipedia.org/wiki/Peak_signal-to-noise_ratio>psnr</a></li><li><a href=https://en.wikipedia.org/wiki/Structural_similarity>ssim</a></li><li><a href=https://en.wikipedia.org/wiki/Video_Multimethod_Assessment_Fusion>vmaf</a></li></ul><p><br>Each of above methods validates a completely different aspect of quality.</p><p>PSNR: Peak signal to noise ratio, is a logarithimic representation of mean squared error. For images it typically represents error/deviation/noise as introduced by compression as compared to original image. It is represented in dB and higher number is closer to original image. It is an approximation to human perception of reconstruction quality. This is not the preferred metric.</p><p>SSIM: Structual similarity index measure, a perception-based model that considers image degradation as perceived change in structural information, while also incorporating important perceptual phenomena, including both luminance masking and contrast masking terms. Structural information is the idea that the pixels have strong inter-dependencies especially when they are spatially close. The resulting value is a decimal value between range 0-1, where 1 is reachable only with original data. The goal is to stay as close to 1 as possible with as lowest bitrate.</p><p>VMAF: Video Multimethod Assessment Fusion, is a full video quality metric developed by Netflix. Their blogs have a much detailed information on what it means and how to interpret it. See details in these posts: <a href=https://netflixtechblog.com/toward-a-practical-perceptual-video-quality-metric-653f208b9652>Towards a practical perceptual video quality metric</a> and <a href=https://netflixtechblog.com/vmaf-the-journey-continues-44b51ee9ed12>vmaf, the journey continues</a></p><p>\</p><pre tabindex=0><code>Interpreting VMAF Scores:
VMAF scores range from 0 to 100, with 0 indicating the lowest quality, and 100 the highest. A good way to think about a VMAF score is to linearly map it to the human opinion scale under which condition the training scores are obtained. As an example, the default model v0.6.1 is trained using scores collected by the Absolute Category Rating (ACR) methodology using a 1080p display with viewing distance of 3H. Viewers voted the video quality on the scale of “bad”, “poor”, “fair”, “good” and “excellent”, and roughly speaking, “bad” is mapped to the VMAF scale 20 and “excellent” to 100. Thus, a VMAF score of 70 can be interpreted as a vote between “good” and “fair” by an average viewer under the 1080p and 3H condition.
</code></pre><hr><p>Now, back to business for checking quality. Having built a ffmpeg with vmaf support locally on linux/wsl. Things are simpler now. Netflix provides a tool on windows, but it does not seem to work with files compressed with different encoders. With ffmpeg one can invoke it as a filter and let ffmpeg uncompress images for it to compare and evaluate quality metrics.</p><p>Netflix went about defining various models on vmaf evaluation. I am using 1080p here. First step is to download the model json file</p><pre tabindex=0><code>cd ~\temp
curl https://raw.githubusercontent.com/Netflix/vmaf/master/model/vmaf_v0.6.1.json -o vmaf_v0.6.1.json 
</code></pre><p><br>Then, run following command with ffmpeg, order of inputs is important. First <code>-i</code> (input) is always the the one you want to check with ref, second <code>-i</code> (input).</p><pre tabindex=0><code>ffmpeg -i &lt;tocheck.mp4&gt; -i &lt;ref.mp4&gt; -lavfi libvmaf=&#34;n_threads=4:model_path=./vmaf_v0.6.1.json:log_fmt=json:ssim=1:log_path=./vmaf.txt:psnr=1:ssim=1&#34; -f null -
</code></pre><p><br>libvmaf is quite fussy about where your model file is kept. For simplicity, I copied model file to <code>~\temp</code> directory and ran ffmpeg from that directory. That way, specifying path was simpler whether running on windows/linux/wsl.</p><p>libvmaf takes several parameters:</p><ul><li><code>n_threads</code>: how many concurrent threads to use, I noticed it does not benefit really to have more than 4 threads.</li><li><code>model_path</code>: specify where the model file is kept. Prefer <code>json</code> file instead of <code>pkl</code> file.</li><li><code>log_fmt</code>: specifies in what format log file should be written out. I went with json, but one can specify xml and csv as well. See <a href=https://github.com/Netflix/vmaf/blob/e23732666b24792fee70afbb830b2f1805db30d6/libvmaf/src/compute_vmaf.c#L9>github.com/vmaf/compute_vmaf.c</a>.</li><li><code>log_path</code>: specify where to write per frame data. I chose to write in current directory. Again, trying to simplify usage across windows and linux.</li><li><code>psnr</code>: set to 1, if you want it to be computed</li><li><code>ssim</code>: set to 1, if you want it to be computed</li></ul><p><br>Now sit back and do someting useful, it will take its own sweet time. Here is a dump from my vmaf run
(I ran it single threaded, could have sped it up with <code>n_threads=4</code>):</p><pre tabindex=0><code>ffmpeg -i /media/sarang/028B-EF23/scratch/test2/NVENC-H264-CQP16-K0-MaxQ-High.x265.crf20.mp4 -i /media/sarang/028B-EF23/scratch/test2/NVENC-H264-CQP16-K0-MaxQ-High.mp4 -lavfi libvmaf=&#34;model_path=./vmaf_v0.6.1.json:log_fmt=json:ssim=1:log_path=VMAF.txt&#34; -f null -
ffmpeg version N-101857-g0617e57 Copyright (c) 2000-2021 the FFmpeg developers
 ...
 ...
Input #0, mov,mp4,m4a,3gp,3g2,mj2, from &#39;/media/sarang/028B-EF23/scratch/test2/NVENC-H264-CQP16-K0-MaxQ-High.x265.crf20.mp4&#39;:
  Metadata:
    ...
  Duration: 00:02:17.67, start: 0.000000, bitrate: 2772 kb/s
  Stream #0:0(und): Video: hevc (Main) (hev1 / 0x31766568), yuv420p(tv, progressive), 1920x1080 [SAR 1:1 DAR 16:9], 2508 kb/s, 30 fps, 30 tbr, 15360 tbn, 30 tbc (default)
    Metadata:
    ...
Input #1, mov,mp4,m4a,3gp,3g2,mj2, from &#39;/media/sarang/028B-EF23/scratch/test2/NVENC-H264-CQP16-K0-MaxQ-High.mp4&#39;:
  Metadata:
  ...
  Duration: 00:02:17.67, start: 0.000000, bitrate: 12556 kb/s
  ...
Stream mapping:
  Stream #0:0 (hevc) -&gt; libvmaf:main (graph 0)
  Stream #1:0 (h264) -&gt; libvmaf:reference (graph 0)
  libvmaf (graph 0) -&gt; Stream #0:0 (wrapped_avframe)
  Stream #0:1 -&gt; #0:1 (aac (native) -&gt; pcm_s16le (native))
Press [q] to stop, [?] for help
Output #0, null, to &#39;pipe:&#39;:
  Metadata:
    major_brand     : isom
    minor_version   : 512
    compatible_brands: isomiso2mp41
    encoder         : Lavf58.77.100
  Stream #0:0: Video: wrapped_avframe, yuv420p(tv, progressive), 1920x1080 [SAR 1:1 DAR 16:9], q=2-31, 200 kb/s, 30 fps, 30 tbn (default)
    Metadata:
      encoder         : Lavc58.135.100 wrapped_avframe
  Stream #0:1(und): Audio: pcm_s16le, 48000 Hz, stereo, s16, 1536 kb/s (default)
    Metadata:
      handler_name    : SoundHandler
      vendor_id       : [0][0][0][0]
      encoder         : Lavc58.135.100 pcm_s16le
libvmaf INFO `compute_vmaf()` is deprecated and will be removed in a future libvmaf version
</code></pre><p><br>I am comparing and evaluating metrics between two differently encoded streams. First is <code>H265</code> and second is source <code>H264</code>, so ffmpeg made life much simpler. Second, we are outputting to <code>-f null -</code>, ie not saving it anywhere. End result is a print about vmaf and ssim scores.<br><br>In this case, vmaf was ~91 and ssim was ~98. So overall this is good quality encoding, which went down to ~2772kbps from ~12550kpbs (roughly 5x reduction in file size with a good quality encoding). Sounds like a win to me :).<br><br>I compared file visually later on and both of them looked same on my monitor, I think this is good enough for archival.</p><hr><p>A note about model file:</p><ul><li>a few tutorials online suggest to get <code>.pkl</code> file, it is deprecated now in favor of <code>.json</code> file</li><li>online recommendation is to keep your model files in <code>\usr\local\share\model</code>, which requires sudo access first of all. It is better to keep it else where and specify <code>model_path</code></li><li>I found that specifing relative path to <code>.json</code> file with current directory where I am executing ffmpeg behaved better than specifying absolute path to <code>.json</code></li><li>I downloaded only 1 model file, instead of entire bunch</li><li>for some reason <code>psnr</code> could not be specified- but i don&rsquo;t care about it much. SSIM is much better</li></ul><hr><p>Links:</p><ul><li><a href=https://ffmpeg.org/ffmpeg-filters.html#libvmaf>ffmpeg filters, ffmpeg</a></li><li><a href=https://github.com/Netflix/vmaf/blob/master/libvmaf/README.md>libvmaf readme, github</a></li><li><a href=https://jina-liu.medium.com/a-practical-guide-for-vmaf-481b4d420d9c>practical guide to libvmaf, medium</a></li><li><a href=https://en.wikipedia.org/wiki/Video_Multimethod_Assessment_Fusion>vmaf, wikipedia</a></li><li><a href=https://netflixtechblog.com/vmaf-the-journey-continues-44b51ee9ed12>vmaf journey, netflixblog</a></li><li><a href=https://netflixtechblog.com/toward-a-practical-perceptual-video-quality-metric-653f208b9652>vmaf, netflixblog</a></li><li><a href=https://github.com/Netflix/vmaf/issues/770>lower cpu & fps, issue 770, github</a></li><li><a href=https://github.com/Netflix/vmaf/issues/74>resolution, display, ht and quality metrics, issue 74, github</a></li><li><a href=https://medium.com/@sethgoldin/using-netflixs-vmaf-to-validate-the-quality-of-imf-and-nvenc-generated-h-264-1991cb803adc>build and test vmaf, medium</a></li><li><a href=https://stackoverflow.com/questions/62753638/how-to-sync-frames-while-calculating-vmaf-score-using-ffmpeg>how to sync frames while calculating vmaf score using ffmpeg, stackoverflow</a></li><li><a href=https://github.com/Netflix/vmaf/blob/master/resource/doc/ffmpeg.md>netflix/vmaf readme, github</a></li><li><a href=https://ottverse.com/vmaf-easyvmaf/>easyvmf, ottverse</a></li><li><a href=https://streaminglearningcenter.com/blogs/lesson-of-the-week-computing-vmaf-with-ffmpeg-on-windows.html>computing with vmaf, streaminglearningcenter</a></li><li><a href=https://streaminglearningcenter.com/blogs/installing-and-using-netflix-vmaf-master.html>installing and using netflix vmaf on windows, streaminglearningcenter</a></li><li><a href=https://forum.doom9.org/>a ton of posts on doom9 forums</a></li></ul><div class=blog-tags><a href=https://www.variadic.xyz//tags/misc/>misc</a>&nbsp;
<a href=https://www.variadic.xyz//tags/linux/>linux</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://www.variadic.xyz/2021/04/06/ffmpeg-vmaf/ data-toggle=tooltip data-placement=top title="building ffmpeg with vmaf support">&larr; Previous Post</a></li><li class=next><a href=https://www.variadic.xyz/2021/04/12/libvmaf-output/ data-toggle=tooltip data-placement=top title="vmaf output">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">Sarang Baheti
&nbsp;&bull;&nbsp;&copy;
2023
&nbsp;&bull;&nbsp;
<a href=https://www.variadic.xyz/>a few notes</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.101.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity=sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://www.variadic.xyz/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://www.variadic.xyz/js/load-photoswipe.js></script></body></html>